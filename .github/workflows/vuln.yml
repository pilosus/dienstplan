name: Check for vulnerable dependencies

on:
  workflow_dispatch:
  schedule:
    # Once a month, 03:00 UTC on the 1st day
    - cron: "0 3 1 * *"

permissions:
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest
    # Scheduled workflows run on the default branch; this guard avoids surprises.
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Clojure CLI
        uses: DeLaGuardo/setup-clojure@13.4
        with:
          cli: "latest"

      - name: Run clj-watson scan
        env:
          CLJ_WATSON_NVD_API_KEY: ${{ secrets.CLJ_WATSON_NVD_API_KEY }}
          CLJ_WATSON_ANALYZER_OSSINDEX_USER: ${{ secrets.CLJ_WATSON_ANALYZER_OSSINDEX_USER }}
          CLJ_WATSON_ANALYZER_OSSINDEX_PASSWORD: ${{ secrets.CLJ_WATSON_ANALYZER_OSSINDEX_PASSWORD }}
        run: clojure -M:watson -p deps.edn
