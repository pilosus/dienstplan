
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Slack bot app for duty rotations">
      
      
      
        <link rel="canonical" href="https://dienstplan-slack.pilosus.org/install/">
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../usage/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.37">
    
    
      
        <title>Installation - dienstplan</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8c3ca2c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#installation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="dienstplan" class="md-header__button md-logo" aria-label="dienstplan" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            dienstplan
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Installation
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/pilosus/dienstplan/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="dienstplan" class="md-nav__button md-logo" aria-label="dienstplan" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    dienstplan
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pilosus/dienstplan/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Installation
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#server-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Server requirements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Environment variables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-to-production" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment to production
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deployment to production">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    <span class="md-ellipsis">
      Docker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jar-file" class="md-nav__link">
    <span class="md-ellipsis">
      Jar file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-playbook" class="md-nav__link">
    <span class="md-ellipsis">
      Ansible Playbook
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-locally" class="md-nav__link">
    <span class="md-ellipsis">
      Running locally
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extra-configs" class="md-nav__link">
    <span class="md-ellipsis">
      Extra configs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Extra configs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#socket-server" class="md-nav__link">
    <span class="md-ellipsis">
      Socket Server
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#slack-settings" class="md-nav__link">
    <span class="md-ellipsis">
      Slack settings
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Usage
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#server-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Server requirements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Environment variables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-to-production" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment to production
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deployment to production">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    <span class="md-ellipsis">
      Docker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jar-file" class="md-nav__link">
    <span class="md-ellipsis">
      Jar file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-playbook" class="md-nav__link">
    <span class="md-ellipsis">
      Ansible Playbook
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-locally" class="md-nav__link">
    <span class="md-ellipsis">
      Running locally
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extra-configs" class="md-nav__link">
    <span class="md-ellipsis">
      Extra configs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Extra configs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#socket-server" class="md-nav__link">
    <span class="md-ellipsis">
      Socket Server
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#slack-settings" class="md-nav__link">
    <span class="md-ellipsis">
      Slack settings
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="installation">Installation</h1>
<h2 id="server-requirements">Server requirements</h2>
<ul>
<li><code>Docker</code> <strong>or</strong> <code>Java 17</code> or higher</li>
<li>PostgreSQL 9.4 or higher</li>
<li>(Optionally) <a href="https://sentry.io/">Sentry account</a> for error tracking</li>
</ul>
<p>NB! Lower versions may work too, but never tested.</p>
<h2 id="environment-variables">Environment variables</h2>
<p>The app relies on the following environment variables (envs) to operate:</p>
<ul>
<li><code>APP__VERSION</code> - app version, used in Sentry reporting</li>
<li><code>APP__ENV</code> [default <code>production</code>] - app environment (e.g. <code>test</code>, <code>stage</code>, <code>production</code>), used in Sentry reporting</li>
<li><code>SLACK__TOKEN</code> [default <code>Token</code>] - Slack Bot User OAuth Token (see details in the <code>Slack settings</code> section)</li>
<li><code>SLACK__SIGN</code> [default <code>Secret</code>] - Slack Signing Secret key (see details in the <code>Slack settings</code> section)</li>
<li><code>ALERTS__SENTRY_DSN</code> - Sentry <a href="https://docs.sentry.io/product/sentry-basics/dsn-explainer/">data source name</a> [default <code>https://public:private@localhost/1</code>]</li>
<li><code>SERVER__PORT</code> [default <code>8080</code>] - Jetty application server port</li>
<li><code>SERVER__LOGLEVEL</code> [default <code>INFO</code>] - App log level (<code>dienstplan</code> logger only)</li>
<li><code>SERVER__ROOTLEVEL</code> [default <code>INFO</code>] - Root log level (all loggers, including DB, Jetty server, etc.)</li>
<li><code>SERVER__ACCESS_LOG</code> [default <code>true</code>] - Enable access logging? Access logs have <code>INFO</code> level.</li>
<li><code>DAEMON__DELAY</code> [default <code>60</code>] - Delay in seconds for checks in the schedule daemon</li>
<li><code>DB__SERVER_NAME</code> [default <code>localhost</code>] - PostgreSQL server host name</li>
<li><code>DB__PORT_NUMBER</code> [default <code>5432</code>] - PostgreSQL server port number</li>
<li><code>DB__DATABASE_NAME</code> [default <code>dienstplan</code>] - PostgreSQL server database name</li>
<li><code>DB__USERNAME</code> [default <code>dienstplan</code>] - PostgreSQL server user name</li>
<li><code>DB__PASSWORD</code> [default <code>dienstplan</code>] - PostgreSQL server password</li>
<li><code>DB__POOL_MIN_IDLE</code> [default <code>20</code>] - PostgreSQL connection pool's min number of idle connections</li>
<li><code>DB__POOL_MAX_SIZE</code> [default <code>20</code>] - PostgreSQL connection pool's max number of connections</li>
<li><code>DB__TIMEOUT_MS_CONNECTION</code> [default <code>10000</code>] - PostgreSQL connection timeout in milliseconds</li>
<li><code>DB__LIFETIME_MAX_MS_CONNECTION</code> [default <code>1800000</code>] - Maximum lifetime of a connection in the pool in milliseconds</li>
<li><code>DB__LIFETIME_KEEPALIVE_MS_CONNECTION</code> [default <code>0</code>] - Keep alive in milliseconds for idle connections in the pool</li>
</ul>
<h2 id="deployment-to-production">Deployment to production</h2>
<p><code>dienstplan</code> is a Clojure program that can be deployed as:</p>
<ul>
<li>a <code>Docker</code> container</li>
<li><code>jar</code> or <code>uberjar</code> file</li>
</ul>
<h3 id="docker">Docker</h3>
<p>The easiest option to run an app is by using a <a href="https://hub.docker.com/r/pilosus/dienstplan/">Docker
image</a>:</p>
<pre><code class="language-bash">$ docker pull pilosus/dienstplan:X.Y.Z

$ docker run \
  -e APP__VERSION=&quot;X.Y.Z&quot; \
  -e APP__ENV=&quot;production&quot; \
  -e APP__DEBUG=false \
  -e SLACK__TOKEN=&quot;xoxb-Your-Bot-User-OAuth-Token&quot; \
  -e SLACK__SIGN=&quot;Your-Signing-Secret&quot; \
  -e ALERTS__SENTRY_DSN=&quot;https://public:private@localhost/1&quot; \
  -e SERVER__PORT=8080 \
  -e SERVER__LOGLEVEL=INFO \
  -e DB__SERVER_NAME=your-postgresql.example.com \
  -e DB__PORT_NUMBER=5432 \
  -e DB__DATABASE_NAME=&quot;your-postgresql-db-name&quot; \
  -e DB__USERNAME=&quot;your-postgresql-db-username&quot; \
  -e DB__PASSWORD=&quot;your-postgresql-db-passwords&quot; \
  -it --rm pilosus/dienstplan:X.Y.Z \
  java -jar app.jar --mode server
</code></pre>
<p>For database migrations and rollbacks instead of <code>java -jar app.jar
--mode server</code> entypoint use:</p>
<ul>
<li><code>java -jar app.jar --mode migrate</code></li>
<li><code>java -jar app.jar --mode rollback</code></li>
</ul>
<p>For schedules processing as one-time job use:</p>
<ul>
<li><code>java -jar app.jar --mode schedule</code></li>
</ul>
<p>For schedules processing as a background running worker (daemon) use:</p>
<ul>
<li><code>java -jar app.jar --mode schedule-daemon</code></li>
</ul>
<p>It's recommended to use a SemVer tag matching the <a href="https://github.com/pilosus/dienstplan/releases">latest
release</a> for a Docker
image (e.g. <code>pilosus/dienstplan:X.Y.Z</code>). Do not rely on the
<code>pilosus/dienstplan:latest</code> unless you know what you are doing!</p>
<h3 id="jar-file">Jar file</h3>
<ul>
<li>Get <a href="https://www.clojure.org/guides/install_clojure">Clojure</a> to compile a standalone <code>jar</code> file</li>
<li>Clone the <a href="https://github.com/pilosus/dienstplan">GitHub repository</a> with <code>git clone git@github.com:pilosus/dienstplan.git</code></li>
<li>In the repo directory complile a standalone <code>jar</code> file with <code>make uberjar</code></li>
<li>Run the app:</li>
</ul>
<pre><code class="language-bash">$ APP__DEBUG=false \
  SLACK__TOKEN=&quot;xoxb-Your-Bot-User-OAuth-Token&quot; \
  SLACK__SIGN=&quot;Your-Signing-Secret&quot; \
  ALERTS__SENTRY_DSN=&quot;https://public:private@localhost/1&quot; \
  SERVER__PORT=8080 \
  SERVER__LOGLEVEL=INFO \
  DB__SERVER_NAME=your-postgresql.example.com \
  DB__PORT_NUMBER=5432 \
  DB__DATABASE_NAME=&quot;your-postgresql-db-name&quot; \
  DB__USERNAME=&quot;your-postgresql-db-username&quot; \
  DB__PASSWORD=&quot;your-postgresql-db-passwords&quot; \
  java -jar /path/to/repo/target/uberjar/dienstplan-X.Y.Z-standalone.jar
</code></pre>
<p>For database migrations and rollbacks instead of <code>java -jar dienstplan-X.Y.Z-standalone.jar</code> entypoint use:</p>
<ul>
<li><code>java -jar dienstplan-X.Y.Z-standalone.jar --mode migrate</code></li>
<li><code>java -jar dienstplan-X.Y.Z-standalone.jar --mode rollback</code></li>
</ul>
<p>For schedules processing as one-time job use:</p>
<ul>
<li><code>java -jar dienstplan-X.Y.Z-standalone.jar --mode schedule</code></li>
</ul>
<p>For schedules processing as a daemon use:</p>
<ul>
<li><code>java -jar dienstplan-X.Y.Z-standalone.jar --mode schedule-daemon</code></li>
</ul>
<h3 id="ansible-playbook">Ansible Playbook</h3>
<p>You can get a full set of installation scripts needed to:</p>
<ul>
<li>Provision a GNU/Linux server from scratch</li>
<li>Set up the <code>dienstplan</code> bot app as a <code>systemd</code> service</li>
<li>Apply database migrations automatically as a <code>systemd</code> service</li>
<li>Run the app</li>
</ul>
<p>in the <a href="https://github.com/pilosus/dienstplan-deploy/">dienstplan-deploy</a> repository.</p>
<h2 id="running-locally">Running locally</h2>
<p>The app can be run locally with <code>Docker Compose</code> with:</p>
<pre><code class="language-bash">make build
make up
make migrate
</code></pre>
<p>These will build a Docker container, start the app and the database
locally, and apply database migrations.</p>
<p>Another way to run the app is with Clojure CLI:</p>
<pre><code class="language-bash">clojure M:run
</code></pre>
<p>Schedules processing as a one-time job can be done:</p>
<pre><code class="language-bash">make schedule
</code></pre>
<p>or</p>
<pre><code class="language-bash">clojure -X:schedule
</code></pre>
<p>Scheduling processing as a daemon (background worker) can be done:</p>
<pre><code class="language-bash">make daemon
</code></pre>
<p>or</p>
<pre><code class="language-bash">clojure -X:schedule-daemon
</code></pre>
<p>Don't forget to use envs to configure the app properly.</p>
<h2 id="extra-configs">Extra configs</h2>
<p>Java system properties allow to configure some extra behaviours of the
app.  System properties can be passed as an option
<code>-Dproperty.name=property.value</code> in <code>java</code> invocation:</p>
<pre><code class="language-bash">java -Dproperty.name=property.value -jar app.jar
</code></pre>
<p>including in Docker entrypoints:</p>
<pre><code class="language-bash">docker run -it --rm pilosus/dienstplan:X.Y.Z java -Dproperty.name=property.value -jar app.jar
</code></pre>
<h3 id="logging">Logging</h3>
<p>By default, logs are printed to the standard output in plain text
format. It may be optimal for local development or staging
environment, but structured logging with JSON stream of events suits
best production grade installations. To enable logging in JSON format
use the following system props:</p>
<pre><code class="language-bash">java -Dlogback.configurationFile=resources/logback.json.xml ...
</code></pre>
<p>Custom logging configs can be written and passed in to the app using
the same system property. See the <a href="https://logback.qos.ch/manual/configuration.html">logback
manual</a> for more
details.</p>
<h3 id="socket-server">Socket Server</h3>
<p>Clojure allows to start a <a href="https://clojure.org/reference/repl_and_main#_launching_a_socket_server">socket
server</a>
at initialization using system properties:</p>
<pre><code class="language-bash">java -Dclojure.server.repl=&quot;{:port 5555 :accept clojure.core.server/repl} ...&quot;
</code></pre>
<p>See the
<a href="https://blog.pilosus.org/posts/2023/07/07/debugging-and-patching-clojure-code-running-in-production-using-socket-server-and-repl/">guide</a>
for more details.</p>
<h2 id="slack-settings">Slack settings</h2>
<p>In order to install the app in your Slack workspace, do the following:</p>
<ul>
<li>Sign in to your Slack <a href="https://api.slack.com/apps">Apps Dashboard</a></li>
<li><code>Create New App</code> -&gt; <code>From an app manifest</code> -&gt; <code>Workspace: your workspace</code></li>
<li>Copy and paste the app manifest in YAML format:</li>
</ul>
<pre><code class="language-yaml">_metadata:
  major_version: 1
  minor_version: 1
display_information:
  name: dienstplan
  description: Slack bot for duty rotations
  background_color: &quot;#002087&quot;
features:
  bot_user:
    display_name: dienstplan
    always_online: false
oauth_config:
  scopes:
    bot:
      - app_mentions:read
      - channels:read
      - chat:write
      - chat:write.customize
settings:
  event_subscriptions:
    request_url: https://YOUR-DOMAIN/api/events
    bot_events:
      - app_mention
  org_deploy_enabled: false
  socket_mode_enabled: false
  token_rotation_enabled: false
</code></pre>
<ul>
<li>Fix <code>settings -&gt; event_subscriptions -&gt; request_url</code> to match your server's public url (<code>/api/events</code> url path is hardcoded in the app)</li>
<li><code>Basic Information</code> -&gt; <code>Install your app</code> -&gt; <code>Install to Workspace</code></li>
<li><code>OAuth &amp; Permissions</code> -&gt; copy <code>OAuth Tokens for Your Workspace</code> to be used for <code>SLACK__TOKEN</code> environment variable</li>
<li><code>Basic Information</code> -&gt; <code>App Credentials</code> -&gt; copy <code>Signing Secret</code> to be used for <code>SLACK__SIGN</code> environment variable</li>
<li>Make it looking nice: <code>Basic Information</code> -&gt; <code>Display Information</code> -&gt; upload an <a href="https://openclipart.org/detail/233274/circle-arrow">app icon</a> with a public domain license</li>
<li>Deploy the app</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © Vitaly Samigullin and contributors
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6f25eb3.min.js"></script>
      
    
  </body>
</html>